// =========================================================================
// 1. üîß BI·∫æN TO√ÄN C·ª§C & KH·ªûI T·∫†O
// =========================================================================

// Khai b√°o bi·∫øn to√†n c·ª•c
let questions = [];
let currentQuestionIndex = 0;
let selectedAnswers = [];
let showAnswerMode = false;
let autoNextDelay = 0;
let countdownInterval;
let timeLeftInSeconds = 0;

// H√†m kh·ªüi t·∫°o khi t·∫£i trang
window.onload = async () => {
    await loadQuestions();          // T·∫£i c√¢u h·ªèi
    setupAutoNext();                // C√†i ƒë·∫∑t t·ª± ƒë·ªông chuy·ªÉn c√¢u

    // K√≠ch ho·∫°t n√∫t ch·ªçn ch·∫ø ƒë·ªô sau khi t·∫£i xong
    document.querySelectorAll('button[id^="btn-mode"]').forEach(btn => {
        btn.disabled = false;
    });

    // üåô ƒê·∫∑t ch·∫ø ƒë·ªô t·ªëi l√†m m·∫∑c ƒë·ªãnh khi t·∫£i trang
    document.body.classList.add('dark');
};

// =========================================================================
// 2. üì¶ X·ª¨ L√ù D·ªÆ LI·ªÜU & TR·∫†NG TH√ÅI
// =========================================================================

// T·∫£i danh s√°ch c√¢u h·ªèi t·ª´ server
async function loadQuestions() {
    try {
        const res = await fetch('/questions');
        questions = await res.json();
        selectedAnswers = new Array(questions.length).fill(null);
    } catch (err) {
        alert('Kh√¥ng th·ªÉ t·∫£i c√¢u h·ªèi!');
        console.error(err);
    }
}

// L·∫•y ch·ªâ s·ªë ƒë√∫ng t·ª´ k√Ω t·ª± (A=0, B=1, ...)
function getCorrectIndex(letter) {
    return letter.charCodeAt(0) - 65;
}

// Ki·ªÉm tra xem c√≥ ƒë√°p √°n ƒë√∫ng n√†o kh√¥ng h·ª£p l·ªá
function hasInvalidCorrectAnswers() {
    for (const q of questions) {
        if (!q.correct || typeof q.correct !== 'string' || getCorrectIndex(q.correct) >= q.answers.length) {
            return true;
        }
    }
    return false;
}

// =========================================================================
// 3. üñºÔ∏è HI·ªÇN TH·ªä C√ÇU H·ªéI & GIAO DI·ªÜN
// =========================================================================

// Hi·ªÉn th·ªã c√¢u h·ªèi hi·ªán t·∫°i
function renderQuestion() {
    const question = questions[currentQuestionIndex];
    if (!question) return;

    document.getElementById('question-text').innerText =
        `${currentQuestionIndex + 1}. ${question.question}`;

    const optionsEl = document.getElementById('options');
    optionsEl.innerHTML = '';

    question.answers.forEach((answer, i) => {
        const btn = document.createElement('button');
        btn.innerText = answer;
        btn.onclick = () => selectAnswer(i);

        if (selectedAnswers[currentQuestionIndex] === i) {
            btn.classList.add('selected');
        }

        if (showAnswerMode && i === getCorrectIndex(question.correct)) {
            btn.style.border = '2px solid green';
        }

        optionsEl.appendChild(btn);
    });

    updateQuestionButtons();
}

// T·∫°o danh s√°ch n√∫t c√¢u h·ªèi
function renderQuestionButtons() {
    const list = document.getElementById('question-list');
    list.innerHTML = '';
    questions.forEach((_, i) => {
        const btn = document.createElement('button');
        btn.innerText = i + 1;
        btn.onclick = () => {
            currentQuestionIndex = i;
            renderQuestion();
        };
        list.appendChild(btn);
    });
}

// C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t c√¢u h·ªèi
function updateQuestionButtons() {
    const buttons = document.querySelectorAll('#question-list button');
    buttons.forEach((btn, i) => {
        btn.classList.remove("active", "answered");
        if (i === currentQuestionIndex) btn.classList.add("active");
        if (selectedAnswers[i] !== null) btn.classList.add("answered");
    });
}

// =========================================================================
// 4. ‚úçÔ∏è X·ª¨ L√ù CH·ªåN ƒê√ÅP √ÅN & ƒêI·ªÄU H∆Ø·ªöNG
// =========================================================================

// Ch·ªçn ƒë√°p √°n
function selectAnswer(index) {
    selectedAnswers[currentQuestionIndex] = index;
    renderQuestion();
    if (autoNextDelay > 0) {
        setTimeout(() => nextQuestion(), autoNextDelay);
    }
    updateQuizProgress();
}

// Chuy·ªÉn ƒë·∫øn c√¢u h·ªèi tr∆∞·ªõc
function prevQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion();
    }
}

// Chuy·ªÉn ƒë·∫øn c√¢u h·ªèi ti·∫øp theo
function nextQuestion() {
    if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
    }
}

// =========================================================================
// 5. üéØ B·∫ÆT ƒê·∫¶U QUIZ V·ªöI T√ôY CH·ªåN CH·∫æ ƒê·ªò
// =========================================================================

// X·ª≠ l√Ω b·∫Øt ƒë·∫ßu quiz
function handleStartQuiz(shuffleQuestions, shuffleAnswers, showAnswers) {
    if (hasInvalidCorrectAnswers()) {
        alert("‚ö†Ô∏è C√≥ c√¢u h·ªèi ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ƒë√°p √°n. Vui l√≤ng s·ª≠a tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu.");
        return;
    }
    startQuiz(shuffleQuestions, shuffleAnswers, showAnswers);
}

// Kh·ªüi t·∫°o quiz
function startQuiz(shuffleQuestions, shuffleAnswers, showAnswers) {
    if (!questions || questions.length === 0) {
        alert("C√¢u h·ªèi ch∆∞a ƒë∆∞·ª£c t·∫£i xong.");
        return;
    }

    if (shuffleQuestions == false && shuffleAnswers == false && showAnswers == false) {
        document.getElementById("mode-label").innerText = "B√¨nh th∆∞·ªùng";
    }
    if (shuffleQuestions == true && shuffleAnswers == true && showAnswers == false) {
        document.getElementById("mode-label").innerText = "Tr·ªôn c√¢u h·ªèi v√† ƒë√°p √°n";
    }
    if (shuffleQuestions == false && shuffleAnswers == true && showAnswers == false) {
        document.getElementById("mode-label").innerText = "Tr·ªôn ƒë√°p √°n";
    }
    if (shuffleQuestions == false && shuffleAnswers == true && showAnswers == true) {
        document.getElementById("mode-label").innerText = "Hi·ªÉn th·ªã ƒë√°p √°n";
    }

    showAnswerMode = showAnswers;

    if (shuffleQuestions) {
        questions = questions.sort(() => Math.random() - 0.5);
    }

    if (shuffleAnswers) {
        questions.forEach(q => {
            const correctIndex = getCorrectIndex(q.correct);
            const correctAnswer = q.answers[correctIndex];
            q.answers = q.answers.sort(() => Math.random() - 0.5);
            q.correct = String.fromCharCode(q.answers.indexOf(correctAnswer) + 65);
        });
    }

    selectedAnswers = new Array(questions.length).fill(null);
    currentQuestionIndex = 0;

    const timeLimitMinutes = parseInt(document.getElementById("time-limit-select").value);
    const countdownDisplay = document.getElementById("countdown");
    const timeInfo = document.getElementById("time-info");

    if (timeLimitMinutes > 0) {
        timeLeftInSeconds = timeLimitMinutes * 60;
        timeInfo.textContent = `${timeLimitMinutes} ph√∫t`;
        startCountdown();
    } else {
        timeLeftInSeconds = 0;
        timeInfo.textContent = "Kh√¥ng gi·ªõi h·∫°n";
        countdownDisplay.textContent = "--:--";
        clearInterval(countdownInterval);
    }

    document.getElementById("settings-popup").classList.add("hidden");
    renderQuestionButtons();
    renderQuestion();
    updateQuizProgress();
}

// =========================================================================
// 6. ‚è≥ ƒê·∫æM NG∆Ø·ª¢C TH·ªúI GIAN L√ÄM B√ÄI
// =========================================================================

// B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c
function startCountdown() {
    const countdownDisplay = document.getElementById("countdown");
    clearInterval(countdownInterval);

    countdownInterval = setInterval(() => {
        if (timeLeftInSeconds <= 0) {
            clearInterval(countdownInterval);
            countdownDisplay.textContent = "00:00";
            alert("H·∫øt th·ªùi gian! B√†i s·∫Ω ƒë∆∞·ª£c n·ªôp t·ª± ƒë·ªông.");
            handleSubmit();
            return;
        }

        const minutes = Math.floor(timeLeftInSeconds / 60);
        const seconds = timeLeftInSeconds % 60;
        countdownDisplay.textContent = `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
        timeLeftInSeconds--;
    }, 1000);
}

// =========================================================================
// 7. üìä N·ªòP B√ÄI & X·ª¨ L√ù K·∫æT QU·∫¢
// =========================================================================

// X·ª≠ l√Ω n·ªôp b√†i
function handleSubmit() {
    const unanswered = selectedAnswers.filter(ans => ans === null).length;
    if (unanswered > 0) {
        document.getElementById('confirm-submit-popup').classList.remove('hidden');
    } else {
        submitQuiz();
    }
}

// X√°c nh·∫≠n n·ªôp b√†i
function confirmSubmit() {
    document.getElementById('confirm-submit-popup').classList.add('hidden');
    submitQuiz();
}

// ƒê√≥ng popup x√°c nh·∫≠n
function closeConfirmPopup() {
    document.getElementById('confirm-submit-popup').classList.add('hidden');
}

// X·ª≠ l√Ω n·ªôp b√†i v√† t√≠nh ƒëi·ªÉm
function submitQuiz() {
    let correct = 0;
    let unanswered = 0;

    questions.forEach((q, i) => {
        if (!q.correct) return;
        const userAnswer = selectedAnswers[i];

        if (userAnswer === null) {
            unanswered++;
        } else if (userAnswer === getCorrectIndex(q.correct)) {
            correct++;
        } else {
            if (!q.wrongCount) q.wrongCount = 1;
            else q.wrongCount += 1;
        }
    });

    const wrong = questions.length - correct - unanswered;

    document.getElementById('score-detail').innerText =
        `ƒê√∫ng: ${correct}, Sai: ${wrong}, B·ªè qua: ${unanswered}`;
    drawChart(correct, wrong, unanswered);

    const feedbackEl = document.getElementById("score-feedback");
    const total = questions.length;
    const percent = (correct / total) * 100;

    let feedback = "";
    if (percent === 100) feedback = "Xu·∫•t s·∫Øc! B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£ c√°c c√¢u.";
    else if (percent >= 80) feedback = "R·∫•t t·ªët! B·∫°n c√≥ ki·∫øn th·ª©c v·ªØng.";
    else if (percent >= 50) feedback = "Kh√° ·ªïn! C·∫ßn luy·ªán t·∫≠p th√™m.";
    else feedback = "C·∫ßn c·ªë g·∫Øng h∆°n. H√£y √¥n t·∫≠p l·∫°i nh√©!";

    feedbackEl.textContent = feedback;
    document.getElementById('score-popup').classList.remove('hidden');

    // G·ª≠i d·ªØ li·ªáu sai/s·ªë l·∫ßn sai v·ªÅ server
    fetch('/update-questions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(questions)
    })
        .then(res => res.json())
        .then(data => {
            console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t file:', data.message);
        })
        .catch(err => {
            console.error('‚ùå L·ªói khi g·ª≠i d·ªØ li·ªáu:', err);
        });

    // Reset tr·∫°ng th√°i sau khi n·ªôp
    selectedAnswers = new Array(questions.length).fill(null);
    currentQuestionIndex = 0;
    renderQuestionButtons();
    renderQuestion();
}

// ƒê√≥ng popup ƒëi·ªÉm
function closeScorePopup() {
    document.getElementById('score-popup').classList.add('hidden');
}

// V·∫Ω bi·ªÉu ƒë·ªì k·∫øt qu·∫£
function drawChart(correct, wrong, skipped) {
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(() => {
        const data = google.visualization.arrayToDataTable([
            ['Lo·∫°i', 'S·ªë l∆∞·ª£ng'],
            ['ƒê√∫ng', correct],
            ['Sai', wrong],
            ['B·ªè qua', skipped],
        ]);

        const options = {
            title: 'K·∫øt qu·∫£ b√†i l√†m',
            pieHole: 0.4,
            colors: ['#28a745', '#dc3545', '#ffc107'],
        };

        const chart = new google.visualization.PieChart(
            document.getElementById('score-chart')
        );
        chart.draw(data, options);
    });
}

// =========================================================================
// 8. ‚öôÔ∏è C√ÄI ƒê·∫∂T T·ª∞ ƒê·ªòNG CHUY·ªÇN C√ÇU H·ªéI
// =========================================================================

// C√†i ƒë·∫∑t t·ª± ƒë·ªông chuy·ªÉn c√¢u h·ªèi
function setupAutoNext() {
    const sidebarSelect = document.getElementById('sidebar-auto-next');
    const popupSelect = document.getElementById('popup-auto-next');

    const updateDelay = () => {
        autoNextDelay = parseInt(sidebarSelect.value);
        popupSelect.value = sidebarSelect.value;
    };

    sidebarSelect.onchange = updateDelay;
    popupSelect.onchange = () => {
        sidebarSelect.value = popupSelect.value;
        updateDelay();
    };

    updateDelay();
}

// =========================================================================
// 9. üåô CHUY·ªÇN CH·∫æ ƒê·ªò S√ÅNG / T·ªêI
// =========================================================================

// Chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô s√°ng/t·ªëi
function toggleTheme() {
    document.body.classList.toggle('dark');
    renderQuestion(); // C·∫≠p nh·∫≠t l·∫°i c√¢u h·ªèi v√† ƒë√°p √°n
    updateQuizProgress(); // C·∫≠p nh·∫≠t thanh ti·∫øn tr√¨nh
}

// =========================================================================
// 10. üîë FORM ƒêƒÇNG NH·∫¨P V√Ä X√ÅC TH·ª∞C
// =========================================================================

// Hi·ªÉn th·ªã popup ƒëƒÉng nh·∫≠p
function showLoginPopup() {
    document.getElementById('login-popup').classList.remove('hidden');
}

// ƒê√≥ng popup ƒëƒÉng nh·∫≠p
function closeLoginPopup() {
    document.getElementById('login-popup').classList.add('hidden');
    document.getElementById('login-error').textContent = '';
}

// X·ª≠ l√Ω ƒëƒÉng nh·∫≠p admin
async function handleAdminLogin() {
    const username = document.getElementById('admin-username').value;
    const password = document.getElementById('admin-password').value;

    try {
        const response = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
        });

        const result = await response.json();
        if (result.success) {
            window.location.href = './admin/admin.html';
        } else {
            document.getElementById('login-error').textContent = 'Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u.';
        }
    } catch (error) {
        document.getElementById('login-error').textContent = 'L·ªói khi k·∫øt n·ªëi server.';
    }
}

// =========================================================================
// 11. üìè C·∫¨P NH·∫¨T THANH TI·∫æN TR√åNH
// =========================================================================

// C·∫≠p nh·∫≠t thanh ti·∫øn tr√¨nh
function updateQuizProgress() {
    const total = questions.length;
    const answered = selectedAnswers.filter(a => a !== null).length;
    const percent = Math.round((answered / total) * 100);

    const bar = document.getElementById('quiz-progress-bar');
    const text = document.getElementById('quiz-progress-text');

    bar.style.width = `${percent}%`;

    // ƒê·ªïi m√†u theo % ti·∫øn ƒë·ªô
    if (percent < 30) {
        bar.style.background = 'linear-gradient(90deg, #dc3545, #ff6b6b)'; // ƒë·ªè
    } else if (percent < 70) {
        bar.style.background = 'linear-gradient(90deg, #ffc107, #ffe066)'; // v√†ng
    } else {
        bar.style.background = 'linear-gradient(90deg, #28a745, #85e085)'; // xanh
    }

    // N·ªôi dung ƒë·ªông
    let message = '';
    if (percent === 0) message = 'üöÄB·∫Øt ƒë·∫ßu nh√©!';
    else if (percent < 30) message = 'üê¢M·ªõi kh·ªüi ƒë·ªông th√¥i...';
    else if (percent < 60) message = 'üí™Ti·∫øp t·ª•c n√†o!';
    else if (percent < 90) message = 'üèÉ‚Äç‚ôÇÔ∏èG·∫ßn v·ªÅ ƒë√≠ch r·ªìi!';
    else if (percent < 100) message = 'üéØS·∫Øp ho√†n t·∫•t!';
    else message = 'Ho√†n th√†nh! üéâ';

    text.textContent = `${message} (${answered}/${total})`;
}

// =========================================================================
// 12. üìè RESPONSIVE
// =========================================================================
document.addEventListener('DOMContentLoaded', () => {
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const sidebar = document.getElementById('sidebar');

    hamburgerBtn.addEventListener('click', () => {
        sidebar.classList.toggle('active');
    });

    // T√πy ch·ªçn: ƒê√≥ng sidebar khi nh·∫•p ra ngo√†i
    document.addEventListener('click', (e) => {
        if (!sidebar.contains(e.target) && !hamburgerBtn.contains(e.target)) {
            sidebar.classList.remove('active');
        }
    });
});