<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Ch·ªçn file JSON c√¢u h·ªèi</title>
    <style>
      body {
        background-color: #121212;
        color: #fff;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 40px;
        line-height: 1.6;
        margin: 0;
      }

      h2 {
        color: #00ffe7;
        margin-bottom: 20px;
        text-align: center;
      }

      .file-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .file-card {
        background-color: #1f1f1f;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
        border: 1px solid #444;
      }

      .file-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 255, 231, 0.3);
        border-color: #00ffe7;
      }

      .file-card.selected {
        border: 2px solid #00ffe7;
        background-color: #2a2a2a;
      }

      .file-card span {
        font-size: 16px;
        color: #fff;
        display: block;
        margin-top: 10px;
      }

      .file-card i {
        font-size: 24px;
        color: #00ffe7;
      }

      button.back-btn {
        background-color: transparent;
        color: #00ffe7;
        border: 1px solid #00ffe7;
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 16px;
        margin-bottom: 20px;
        transition: background-color 0.3s;
      }

      button.back-btn:hover {
        background-color: #00cdbd;
        color: #000;
      }

      #error-message {
        margin-top: 10px;
        color: #ff6b6b;
        text-align: center;
      }

      textarea {
        width: 100%;
        margin-top: 20px;
        background-color: #1e1e1e;
        color: #00ff95;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 15px;
        font-size: 14px;
        resize: vertical;
      }

      ::selection {
        background-color: #00ffe7;
        color: #000;
      }

      /* Font Awesome for file icons */
      @import url("https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css");
    </style>
  </head>
  <body>
    <h2>üìÅ Ch·ªçn file JSON c√¢u h·ªèi</h2>

    <div class="file-grid" id="file-grid"></div>
    <button class="back-btn" onclick="history.back()">üîô Quay l·∫°i</button>
    <p id="error-message"></p>
    <textarea id="question-content" rows="20" readonly></textarea>

    <script>
      // T√™n file m·∫∑c ƒë·ªãnh
      const DEFAULT_FILENAME = "dtdm.json";

      // H√†m t·∫£i v√† hi·ªÉn th·ªã n·ªôi dung c√¢u h·ªèi
      function loadAndDisplayQuestions(filename) {
        return fetch("/questions")
          .then((res) => {
            if (!res.ok) throw new Error("L·ªói t·∫£i c√¢u h·ªèi");
            return res.json();
          })
          .then((data) => {
            document.getElementById("question-content").value = JSON.stringify(
              data,
              null,
              2
            );
            document.getElementById(
              "error-message"
            ).innerText = `‚úÖ ƒê√£ ch·ªçn file: ${filename}`;

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i selected cho card
            document.querySelectorAll(".file-card").forEach((card) => {
              card.classList.remove("selected");
              if (card.dataset.filename === filename) {
                card.classList.add("selected");
              }
            });
          })
          .catch((err) => {
            console.error(err);
            document.getElementById("error-message").innerText =
              "Kh√¥ng th·ªÉ t·∫£i n·ªôi dung file.";
          });
      }

      // H√†m ch·ªçn file v√† chuy·ªÉn h∆∞·ªõng
      function selectFile(filename) {
        fetch("/set-question-file", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ filename }),
        })
          .then((res) => {
            if (!res.ok) throw new Error("L·ªói ƒë·∫∑t file tr√™n server");
            return res.json();
          })
          .then(() => {
            // Hi·ªÉn th·ªã n·ªôi dung file v√† g·ª≠i t√≠n hi·ªáu reload
            return loadAndDisplayQuestions(filename).then(() => {
              // G·ª≠i t√≠n hi·ªáu reload ƒë·∫øn c√°c trang kh√°c
              const reloadChannel = new BroadcastChannel("reload-channel");
              reloadChannel.postMessage("reload");
              // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang luy·ªán t·∫≠p
              window.location.href = "/index.html";
            });
          })
          .catch((err) => {
            console.error(err);
            document.getElementById("error-message").innerText =
              "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server ho·∫∑c file l·ªói.";
          });
      }

      // L·∫•y danh s√°ch file .json v√† t·∫°o c√°c card
      fetch("/list-question-files")
        .then((res) => res.json())
        .then((files) => {
          const fileGrid = document.getElementById("file-grid");
          let isDefaultFileAvailable = false;

          if (files.length === 0) {
            document.getElementById("error-message").innerText =
              "‚ùå Kh√¥ng t√¨m th·∫•y file JSON n√†o.";
            return;
          }

          // T·∫°o card cho m·ªói file
          files.forEach((file) => {
            const card = document.createElement("div");
            card.className = "file-card";
            card.dataset.filename = file;
            card.innerHTML = `
              <i class="fas fa-file-alt"></i>
              <span>${file}</span>
            `;
            card.addEventListener("click", () => selectFile(file));
            fileGrid.appendChild(card);
            if (file === DEFAULT_FILENAME) {
              isDefaultFileAvailable = true;
            }
          });

          // T·∫£i n·ªôi dung file m·∫∑c ƒë·ªãnh ho·∫∑c file ƒë·∫ßu ti√™n m√† kh√¥ng chuy·ªÉn h∆∞·ªõng
          const initialFile = isDefaultFileAvailable ? DEFAULT_FILENAME : files[0];
          fetch("/set-question-file", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ filename: initialFile }),
          })
            .then((res) => {
              if (!res.ok) throw new Error("L·ªói ƒë·∫∑t file m·∫∑c ƒë·ªãnh tr√™n server");
              return res.json();
            })
            .then(() => loadAndDisplayQuestions(initialFile))
            .catch((err) => {
              console.error(err);
              document.getElementById("error-message").innerText =
                "L·ªói khi ƒë·∫∑t file m·∫∑c ƒë·ªãnh.";
            });
        })
        .catch((err) => {
          console.error(err);
          document.getElementById("error-message").innerText =
            "L·ªói khi t·∫£i danh s√°ch file.";
        });
    </script>
  </body>
</html>